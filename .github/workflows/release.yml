name: Release Extension Asset

on:
  release:
    types: [published]
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Tag/version to release (e.g. v0.1.0)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - pg_major: "13"
            pg_feature: "pg13"
          - pg_major: "14"
            pg_feature: "pg14"
          - pg_major: "15"
            pg_feature: "pg15"
          - pg_major: "16"
            pg_feature: "pg16"
          - pg_major: "17"
            pg_feature: "pg17"
          - pg_major: "18"
            pg_feature: "pg18"
    env:
      PG_MAJOR: ${{ matrix.pg_major }}
      PG_FEATURE: ${{ matrix.pg_feature }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            libclang-dev \
            llvm \
            pkg-config \
            libssl-dev \
            zlib1g-dev \
            libreadline-dev \
            flex \
            bison \
            libzstd-dev \
            curl \
            ca-certificates \
            jq

      - name: Setup Rust Nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-pgrx
        run: |
          if command -v cargo-pgrx >/dev/null 2>&1; then
            echo "cargo-pgrx already present: $(cargo pgrx --version)"
          else
            cargo install cargo-pgrx --locked --version 0.16.1
          fi

      - name: Initialize pgrx (download Postgres)
        env:
          PGRX_HOME: /home/runner/.pgrx
        run: |
          if [ -x "${PGRX_HOME}/${PG_MAJOR}"*/pgrx-install/bin/pg_config ]; then
            echo "pgrx for pg${PG_MAJOR} already initialized"
          else
            cargo pgrx init --pg${PG_MAJOR} download
          fi

      - name: Build package
        run: |
          set -euo pipefail

          VERSION="$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name=="pg_strict") | .version')"
          echo "VERSION=${VERSION}" >> "${GITHUB_ENV}"
          TAG_NAME="${GITHUB_REF_NAME:-}"
          if [ -z "${TAG_NAME}" ] || [[ "${TAG_NAME}" != v* ]]; then
            TAG_NAME="${{ inputs.version }}"
          fi
          if [ -z "${TAG_NAME}" ] || [[ "${TAG_NAME}" != v* ]]; then
            TAG_NAME="v${VERSION}"
          fi
          echo "TAG_NAME=${TAG_NAME}" >> "${GITHUB_ENV}"

          PG_CONFIG="$(cargo pgrx info pg-config "${PG_MAJOR}")"
          echo "Using pg_config at: ${PG_CONFIG}"

          cargo pgrx package \
            --pg-config "${PG_CONFIG}" \
            --no-default-features \
            --features "${PG_FEATURE}" \
            --out-dir dist/pg${PG_MAJOR}

          mkdir -p dist/pg${PG_MAJOR}/extension

          find dist/pg${PG_MAJOR} -type f -name 'pg_strict.control' -exec cp {} dist/pg${PG_MAJOR}/extension/ \;
          find dist/pg${PG_MAJOR} -type f -name "pg_strict--${VERSION}.sql" -exec cp {} dist/pg${PG_MAJOR}/extension/ \;
          find dist/pg${PG_MAJOR} -type f -name 'pg_strict.so' -exec cp {} dist/pg${PG_MAJOR}/extension/ \;

          ls -la dist/pg${PG_MAJOR}/extension

          tar -C dist/pg${PG_MAJOR}/extension -czf \
            "dist/pg_strict-${VERSION}-pg${PG_MAJOR}-linux-x86_64.tar.gz" \
            pg_strict.control \
            "pg_strict--${VERSION}.sql" \
            pg_strict.so

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts for pg${PG_MAJOR}..."
          
          # Check that required files exist
          if [ ! -f "dist/pg${PG_MAJOR}/extension/pg_strict.control" ]; then
            echo "ERROR: pg_strict.control not found"
            exit 1
          fi
          
          if [ ! -f "dist/pg${PG_MAJOR}/extension/pg_strict--${VERSION}.sql" ]; then
            echo "ERROR: pg_strict--${VERSION}.sql not found"
            exit 1
          fi
          
          if [ ! -f "dist/pg${PG_MAJOR}/extension/pg_strict.so" ]; then
            echo "ERROR: pg_strict.so not found"
            exit 1
          fi
          
          # Check tarball was created
          if [ ! -f "dist/pg_strict-${VERSION}-pg${PG_MAJOR}-linux-x86_64.tar.gz" ]; then
            echo "ERROR: tarball not found"
            exit 1
          fi
          
          # Verify tarball contents
          tar -tzf "dist/pg_strict-${VERSION}-pg${PG_MAJOR}-linux-x86_64.tar.gz" | tee /tmp/tar-contents.txt
          
          if ! grep -q "pg_strict.control" /tmp/tar-contents.txt; then
            echo "ERROR: pg_strict.control missing from tarball"
            exit 1
          fi
          
          if ! grep -q "pg_strict--${VERSION}.sql" /tmp/tar-contents.txt; then
            echo "ERROR: pg_strict--${VERSION}.sql missing from tarball"
            exit 1
          fi
          
          if ! grep -q "pg_strict.so" /tmp/tar-contents.txt; then
            echo "ERROR: pg_strict.so missing from tarball"
            exit 1
          fi
          
          echo "âœ… All artifacts verified successfully for pg${PG_MAJOR}"

      - name: Generate release notes
        run: |
          cat > dist/release-notes.md << 'EOF'
          # Installation
          
          ## Quick Install (Linux x86_64)
          
          Download and install the pre-built binary for your PostgreSQL version:
          
          ### PostgreSQL 13
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/pg_strict-${VERSION}-pg13-linux-x86_64.tar.gz
          tar -xzf pg_strict-${VERSION}-pg13-linux-x86_64.tar.gz
          sudo cp pg_strict.so $(pg_config --libdir)/
          sudo cp pg_strict.control pg_strict--${VERSION}.sql $(pg_config --sharedir)/extension/
          ```
          
          ### PostgreSQL 14
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/pg_strict-${VERSION}-pg14-linux-x86_64.tar.gz
          tar -xzf pg_strict-${VERSION}-pg14-linux-x86_64.tar.gz
          sudo cp pg_strict.so $(pg_config --libdir)/
          sudo cp pg_strict.control pg_strict--${VERSION}.sql $(pg_config --sharedir)/extension/
          ```
          
          ### PostgreSQL 15
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/pg_strict-${VERSION}-pg15-linux-x86_64.tar.gz
          tar -xzf pg_strict-${VERSION}-pg15-linux-x86_64.tar.gz
          sudo cp pg_strict.so $(pg_config --libdir)/
          sudo cp pg_strict.control pg_strict--${VERSION}.sql $(pg_config --sharedir)/extension/
          ```
          
          ### PostgreSQL 16
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/pg_strict-${VERSION}-pg16-linux-x86_64.tar.gz
          tar -xzf pg_strict-${VERSION}-pg16-linux-x86_64.tar.gz
          sudo cp pg_strict.so $(pg_config --libdir)/
          sudo cp pg_strict.control pg_strict--${VERSION}.sql $(pg_config --sharedir)/extension/
          ```
          
          ### PostgreSQL 17
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/pg_strict-${VERSION}-pg17-linux-x86_64.tar.gz
          tar -xzf pg_strict-${VERSION}-pg17-linux-x86_64.tar.gz
          sudo cp pg_strict.so $(pg_config --libdir)/
          sudo cp pg_strict.control pg_strict--${VERSION}.sql $(pg_config --sharedir)/extension/
          ```
          
          ### PostgreSQL 18
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/pg_strict-${VERSION}-pg18-linux-x86_64.tar.gz
          tar -xzf pg_strict-${VERSION}-pg18-linux-x86_64.tar.gz
          sudo cp pg_strict.so $(pg_config --libdir)/
          sudo cp pg_strict.control pg_strict--${VERSION}.sql $(pg_config --sharedir)/extension/
          ```
          
          Then enable the extension in PostgreSQL:
          
          ```sql
          CREATE EXTENSION pg_strict;
          ```
          
          ## Build from Source
          
          See the [README](https://github.com/${{ github.repository }}#installation) for detailed instructions on building from source.
          
          ## Verify Installation
          
          ```sql
          SELECT pg_strict_version();
          SELECT * FROM pg_strict_config();
          ```
          
          ## What's Supported
          
          - PostgreSQL versions: 13, 14, 15, 16, 17, 18
          - Platform: Linux x86_64
          - Architecture: amd64
          
          ## Documentation
          
          Full documentation available at: https://github.com/${{ github.repository }}
          EOF

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        if: ${{ github.event_name == 'release' || startsWith(github.ref, 'refs/tags/v') || inputs.version != '' }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          target_commitish: ${{ github.sha }}
          files: dist/pg_strict-${{ env.VERSION }}-pg${{ env.PG_MAJOR }}-linux-x86_64.tar.gz
          body_path: dist/release-notes.md
          overwrite_files: true
